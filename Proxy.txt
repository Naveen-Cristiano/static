# === auth_service/app.py ===
from flask import Flask, request, jsonify
import mysql.connector

app = Flask(__name__)

DB_CONFIG = {
    'host': 'database-1-instance-1.c7uq2skoqqmb.ap-south-1.rds.amazonaws.com',
    'user': 'Admin',
    'password': 'Naveensagar30',
    'database': 'realmadrid_db'
}

@app.route('/signup', methods=['POST'])
def signup():
    data = request.json
    conn = mysql.connector.connect(**DB_CONFIG)
    cursor = conn.cursor()
    cursor.execute("INSERT INTO users (username, password) VALUES (%s, %s)", (data['username'], data['password']))
    conn.commit()
    conn.close()
    return jsonify({'message': 'Signup successful'})

@app.route('/login', methods=['POST'])
def login():
    data = request.json
    conn = mysql.connector.connect(**DB_CONFIG)
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM users WHERE username=%s AND password=%s", (data['username'], data['password']))
    user = cursor.fetchone()
    conn.close()
    if user:
        return jsonify({'message': 'Login successful', 'username': data['username']})
    else:
        return jsonify({'message': 'Login failed'}), 401

if __name__ == '__main__':
    app.run(port=5001, host='0.0.0.0')


# === player_service/app.py ===
from flask import Flask, jsonify
import mysql.connector

app = Flask(__name__)

DB_CONFIG = {
    'host': 'readreplica-1.c7uq2skoqqmb.ap-south-1.rds.amazonaws.com',
    'user': 'Admin',
    'password': 'Naveensagar30',
    'database': 'realmadrid_db'
}

CLOUDFRONT_URL = "https://d1o92qaptx4j65.cloudfront.net"

@app.route('/players', methods=['GET'])
def get_players():
    conn = mysql.connector.connect(**DB_CONFIG)
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM players")
    players = cursor.fetchall()
    for player in players:
        player['image_file'] = f"{CLOUDFRONT_URL}/{player['image_file']}"
    conn.close()
    return jsonify(players)

if __name__ == '__main__':
    app.run(port=5002, host='0.0.0.0')


from flask import Flask, render_template_string, request, redirect
import requests

app = Flask(__name__)

AUTH_SERVICE_URL = "http://127.0.0.1:5001"
PLAYER_SERVICE_URL = "http://127.0.0.1:5002"

@app.route('/new')
def home():
    return render_template_string('''
        <h1>Welcome to Real Madrid Fan Page</h1>
        <a href="/login">Login</a> | <a href="/signup">Signup</a>
    ''')

@app.route('/signup', methods=['GET', 'POST'])
def signup():
    if request.method == 'POST':
        res = requests.post(f"{AUTH_SERVICE_URL}/signup", data=request.form)
        if res.status_code == 200:
            return redirect('/dashboard')
        return "Signup Failed"
    return render_template_string('''
        <h2>Signup</h2>
        <form method="post">
            Username: <input name="username"><br>
            Password: <input name="password" type="password"><br>
            <button type="submit">Signup</button>
        </form>
    ''')

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        res = requests.post(f"{AUTH_SERVICE_URL}/login", data=request.form)
        if res.status_code == 200:
            return redirect('/dashboard')
        return "Login Failed"
    return render_template_string('''
        <h2>Login</h2>
        <form method="post">
            Username: <input name="username"><br>
            Password: <input name="password" type="password"><br>
            <button type="submit">Login</button>
        </form>
    ''')

@app.route('/dashboard')
def dashboard():
    res = requests.get(f"{PLAYER_SERVICE_URL}/players")
    if res.status_code == 200:
        players = res.json()
        html = "<h2>Players</h2>"
        for p in players:
            html += f"<p>{p['player_name']}<br><img src='{p['image_file']}' width='200'></p>"
        return html
    return "Failed to load players"

# New Route for ALB Path-Based Routing
#@app.route('/new')
#def new():
#    return home()

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
